<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TypeRacer 3D - Race Against Time!</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=JetBrains+Mono&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Orbitron', sans-serif;
            background: #000;
            overflow: hidden;
            color: white;
        }
        
        /* Animated Background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #1a1a2e, #16213e, #0f3460);
            z-index: -2;
        }
        
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        /* Main Container */
        .game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        
        /* Header with Neon Effect */
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .title {
            font-size: 56px;
            font-weight: 900;
            text-transform: uppercase;
            background: linear-gradient(45deg, #00f5ff, #ff00ff, #00f5ff);
            background-size: 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: neonGlow 3s infinite;
            text-shadow: 0 0 20px rgba(0, 245, 255, 0.5);
        }
        
        @keyframes neonGlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        /* Race Track */
        .race-track {
            position: relative;
            height: 150px;
            background: linear-gradient(180deg, #1a1a2e 0%, #0f3460 100%);
            border: 3px solid #00f5ff;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0, 245, 255, 0.3);
        }
        
        .track-lines {
            position: absolute;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 50px,
                rgba(255, 255, 255, 0.1) 50px,
                rgba(255, 255, 255, 0.1) 52px
            );
            animation: moveTrack 1s linear infinite;
        }
        
        @keyframes moveTrack {
            0% { transform: translateX(0); }
            100% { transform: translateX(-52px); }
        }
        
        .track-lines.paused {
            animation-play-state: paused;
        }
        
        /* Racing Cars */
        .cars-container {
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            padding: 20px 0;
        }
        
        .car {
            display: flex;
            align-items: center;
            position: relative;
            transition: transform 0.3s ease-out;
        }
        
        .car-icon {
            font-size: 40px;
            filter: drop-shadow(0 0 10px currentColor);
            transition: all 0.3s;
        }
        
        .player-car .car-icon {
            color: #00f5ff;
            animation: carBounce 0.5s infinite;
        }
        
        .opponent-car .car-icon {
            color: #ff00ff;
        }
        
        @keyframes carBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        
        .car-label {
            margin-left: 10px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .finish-line {
            position: absolute;
            right: 20px;
            top: 0;
            height: 100%;
            width: 4px;
            background: repeating-linear-gradient(
                0deg,
                #fff 0px,
                #fff 10px,
                #000 10px,
                #000 20px
            );
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
        }
        
        /* Stats Dashboard */
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(0, 245, 255, 0.1), rgba(255, 0, 255, 0.1));
            border: 2px solid rgba(0, 245, 255, 0.3);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stat-label {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 900;
            color: #00f5ff;
            text-shadow: 0 0 10px rgba(0, 245, 255, 0.5);
        }
        
        /* Typing Area */
        .typing-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(0, 245, 255, 0.3);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        
        .quote-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 28px;
            line-height: 1.8;
            margin-bottom: 20px;
            min-height: 150px;
            letter-spacing: 2px;
        }
        
        .quote-display span {
            position: relative;
            transition: all 0.1s;
        }
        
        .quote-display span.correct {
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.8);
        }
        
        .quote-display span.incorrect {
            color: #ff0055;
            background: rgba(255, 0, 85, 0.3);
            text-shadow: 0 0 10px rgba(255, 0, 85, 0.8);
            animation: shake 0.3s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .quote-display span.current {
            color: #00f5ff;
            text-shadow: 0 0 20px rgba(0, 245, 255, 1);
            animation: pulse 0.8s infinite;
            transform: scale(1.2);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .input-area {
            width: 100%;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #00f5ff;
            border-radius: 10px;
            padding: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 24px;
            color: #00f5ff;
            outline: none;
            resize: none;
            box-shadow: inset 0 0 20px rgba(0, 245, 255, 0.2);
        }
        
        .input-area:focus {
            box-shadow: inset 0 0 30px rgba(0, 245, 255, 0.4), 0 0 30px rgba(0, 245, 255, 0.3);
        }
        
        .input-area.error {
            border-color: #ff0055;
            animation: errorPulse 0.3s;
        }
        
        @keyframes errorPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(0.98); }
        }
        
        /* Controls */
        .controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .btn {
            padding: 15px 40px;
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            font-weight: 700;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .btn-start {
            background: linear-gradient(45deg, #00f5ff, #00ff88);
            color: #000;
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.5);
        }
        
        .btn-start:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 5px 30px rgba(0, 245, 255, 0.8);
        }
        
        .btn-reset {
            background: transparent;
            border: 2px solid #ff00ff;
            color: #ff00ff;
        }
        
        .btn-reset:hover {
            background: #ff00ff;
            color: #000;
        }
        
        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        /* Power-ups */
        .powerups {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }
        
        .powerup {
            width: 60px;
            height: 60px;
            border: 2px solid #00f5ff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            background: rgba(0, 245, 255, 0.1);
        }
        
        .powerup:hover:not(.disabled) {
            transform: scale(1.2) rotate(10deg);
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.8);
        }
        
        .powerup.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .powerup.active {
            animation: powerupActive 0.5s infinite;
            box-shadow: 0 0 30px rgba(0, 255, 136, 1);
            border-color: #00ff88;
        }
        
        @keyframes powerupActive {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .powerup-cost {
            position: absolute;
            bottom: -8px;
            right: -8px;
            background: #ff00ff;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            border: 2px solid #000;
        }
        
        /* Combo System */
        .combo-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 120px;
            font-weight: 900;
            color: #00ff88;
            text-shadow: 0 0 40px rgba(0, 255, 136, 1);
            pointer-events: none;
            opacity: 0;
            z-index: 1000;
        }
        
        .combo-display.show {
            animation: comboShow 1s ease-out;
        }
        
        @keyframes comboShow {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        /* Game Over Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #0f3460);
            border: 3px solid #00f5ff;
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            max-width: 600px;
            box-shadow: 0 0 50px rgba(0, 245, 255, 0.5);
            animation: modalAppear 0.5s ease-out;
        }
        
        @keyframes modalAppear {
            from {
                transform: scale(0.5);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .modal-title {
            font-size: 48px;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #00f5ff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .final-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 30px 0;
        }
        
        .final-stat {
            background: rgba(0, 245, 255, 0.1);
            border: 2px solid rgba(0, 245, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
        }
        
        .final-stat-value {
            font-size: 48px;
            color: #00f5ff;
            font-weight: 900;
            text-shadow: 0 0 20px rgba(0, 245, 255, 0.8);
        }
        
        .achievements {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }
        
        .badge {
            background: linear-gradient(45deg, #ffd700, #ff8c00);
            color: #000;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            animation: badgeAppear 0.5s ease-out;
        }
        
        @keyframes badgeAppear {
            from {
                transform: scale(0) rotate(-180deg);
            }
            to {
                transform: scale(1) rotate(0deg);
            }
        }
        
        /* Difficulty Selector */
        .difficulty-selector {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .diff-btn {
            padding: 10px 25px;
            background: transparent;
            border: 2px solid #00f5ff;
            color: #00f5ff;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            transition: all 0.3s;
        }
        
        .diff-btn.active {
            background: #00f5ff;
            color: #000;
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.8);
        }
        
        .diff-btn:hover:not(.disabled) {
            transform: translateY(-2px);
        }
        
        .diff-btn.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        /* Sound Visualizer */
        .sound-bars {
            display: flex;
            gap: 3px;
            height: 30px;
            align-items: flex-end;
            justify-content: center;
            margin-top: 10px;
        }
        
        .sound-bar {
            width: 4px;
            background: linear-gradient(0deg, #00f5ff, #ff00ff);
            border-radius: 2px;
            animation: soundWave 0.8s ease-in-out infinite;
        }
        
        .sound-bar:nth-child(2) { animation-delay: 0.1s; }
        .sound-bar:nth-child(3) { animation-delay: 0.2s; }
        .sound-bar:nth-child(4) { animation-delay: 0.3s; }
        .sound-bar:nth-child(5) { animation-delay: 0.4s; }
        
        @keyframes soundWave {
            0%, 100% { height: 5px; }
            50% { height: 30px; }
        }
        
        @media (max-width: 768px) {
            .stats-panel {
                grid-template-columns: repeat(3, 1fr);
            }
            .quote-display {
                font-size: 18px;
            }
            .title {
                font-size: 36px;
            }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    <div class="stars" id="stars"></div>
    <div class="combo-display" id="comboDisplay"></div>
    
    <div class="game-container">
        <div class="header">
            <h1 class="title">üèéÔ∏è TypeRacer 3D</h1>
            <div class="sound-bars">
                <div class="sound-bar"></div>
                <div class="sound-bar"></div>
                <div class="sound-bar"></div>
                <div class="sound-bar"></div>
                <div class="sound-bar"></div>
            </div>
        </div>
        
        <div class="difficulty-selector">
            <button class="diff-btn active" data-difficulty="easy">üå± ROOKIE</button>
            <button class="diff-btn" data-difficulty="medium">‚ö° PRO</button>
            <button class="diff-btn" data-difficulty="hard">üî• LEGEND</button>
            <button class="diff-btn" data-difficulty="insane">üíÄ INSANE</button>
        </div>
        
        <div class="race-track">
            <div class="track-lines" id="trackLines"></div>
            <div class="cars-container">
                <div class="car player-car" id="playerCar">
                    <div class="car-icon">üèéÔ∏è</div>
                    <div class="car-label">YOU</div>
                </div>
                <div class="car opponent-car" id="opponentCar">
                    <div class="car-icon">üëª</div>
                    <div class="car-label">GHOST</div>
                </div>
            </div>
            <div class="finish-line"></div>
        </div>
        
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-label">‚è±Ô∏è TIME</div>
                <div class="stat-value" id="timer">60</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">‚ö° WPM</div>
                <div class="stat-value" id="wpm">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üî• COMBO</div>
                <div class="stat-value" id="combo">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üèÜ SCORE</div>
                <div class="stat-value" id="score">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üéØ ACCURACY</div>
                <div class="stat-value" id="accuracy">100</div>
            </div>
        </div>
        
        <div class="typing-section">
            <div class="quote-display" id="quoteDisplay">
                Press START to begin your race!
            </div>
            <textarea class="input-area" id="inputArea" placeholder="Type here to race..." disabled></textarea>
            <div class="powerups">
                <div class="powerup disabled" id="powerupBoost" title="Speed Boost">
                    ‚ö°
                    <div class="powerup-cost">10</div>
                </div>
                <div class="powerup disabled" id="powerupSlow" title="Slow Time">
                    üêå
                    <div class="powerup-cost">15</div>
                </div>
                <div class="powerup disabled" id="powerupShield" title="Error Shield">
                    üõ°Ô∏è
                    <div class="powerup-cost">20</div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-start" id="startBtn">üöÄ START RACE</button>
            <button class="btn btn-reset" id="resetBtn">üîÑ RESET</button>
        </div>
    </div>
    
    <div class="modal" id="gameOverModal">
        <div class="modal-content">
            <h2 class="modal-title">üèÅ RACE COMPLETE!</h2>
            <div class="final-stats">
                <div class="final-stat">
                    <div class="stat-label">FINAL WPM</div>
                    <div class="final-stat-value" id="finalWPM">0</div>
                </div>
                <div class="final-stat">
                    <div class="stat-label">MAX COMBO</div>
                    <div class="final-stat-value" id="finalCombo">0</div>
                </div>
                <div class="final-stat">
                    <div class="stat-label">TOTAL SCORE</div>
                    <div class="final-stat-value" id="finalScore">0</div>
                </div>
                <div class="final-stat">
                    <div class="stat-label">ACCURACY</div>
                    <div class="final-stat-value" id="finalAccuracy">0</div>
                </div>
            </div>
            <div class="achievements" id="achievements"></div>
            <button class="btn btn-start" id="closeModalBtn" style="margin-top: 30px;">üîÑ RACE AGAIN</button>
        </div>
    </div>
    
    <script>
        // Create animated stars
        function createStars() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.width = Math.random() * 3 + 'px';
                star.style.height = star.style.width;
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }
        }
        createStars();
        
        const game = {
            quotes: {
                easy: [
                    "Speed is nothing without control and precision in racing.",
                    "The fastest way to success is through practice every day.",
                    "Winners never quit and quitters never win the big race."
                ],
                medium: [
                    "Champions are made when nobody is watching them train hard.",
                    "The difference between ordinary and extraordinary is practice.",
                    "Success is not final and failure is not fatal for racers."
                ],
                hard: [
                    "To finish first you must first finish the race with determination.",
                    "The will to win means nothing without the will to prepare properly.",
                    "Racing is life and anything before or after is just waiting time."
                ],
                insane: [
                    "Aerodynamically the bumble bee should not be able to fly but it does anyway because nobody told it.",
                    "The most dangerous thing about a race is when your mind writes checks that your body cannot cash.",
                    "If everything seems under control you are just not going fast enough to notice the chaos around."
                ]
            },
            currentQuote: '',
            difficulty: 'easy',
            timeLeft: 60,
            timerInterval: null,
            opponentInterval: null,
            isPlaying: false,
            totalTyped: 0,
            totalErrors: 0,
            currentPosition: 0,
            combo: 0,
            maxCombo: 0,
            score: 0,
            correctStreak: 0,
            shieldActive: false,
            opponentSpeed: 0.3,
            
            init() {
                this.inputArea = document.getElementById('inputArea');
                this.quoteDisplay = document.getElementById('quoteDisplay');
                this.trackLines = document.getElementById('trackLines');
                
                // Event listeners
                this.inputArea.addEventListener('input', () => this.handleInput());
                document.getElementById('startBtn').addEventListener('click', () => this.startGame());
                document.getElementById('resetBtn').addEventListener('click', () => this.resetGame());
                document.getElementById('closeModalBtn').addEventListener('click', () => this.closeModal());
                
                // Difficulty buttons
                document.querySelectorAll('.diff-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.setDifficulty(e.target.dataset.difficulty));
                });
                
                // Powerup buttons
                document.getElementById('powerupBoost').addEventListener('click', () => this.usePowerup('boost'));
                document.getElementById('powerupSlow').addEventListener('click', () => this.usePowerup('slow'));
                document.getElementById('powerupShield').addEventListener('click', () => this.usePowerup('shield'));
                
                this.trackLines.classList.add('paused');
            },
            
            setDifficulty(level) {
                if (this.isPlaying) return;
                
                this.difficulty = level;
                const speeds = { easy: 0.3, medium: 0.5, hard: 0.7, insane: 0.9 };
                this.opponentSpeed = speeds[level];
                
                document.querySelectorAll('.diff-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.difficulty === level) {
                        btn.classList.add('active');
                    }
                });
            },
            
            startGame() {
                this.isPlaying = true;
                this.totalTyped = 0;
                this.totalErrors = 0;
                this.currentPosition = 0;
                this.combo = 0;
                this.maxCombo = 0;
                this.score = 0;
                this.correctStreak = 0;
                this.timeLeft = 60;
                this.shieldActive = false;
                
                document.getElementById('startBtn').disabled = true;
                document.querySelectorAll('.diff-btn').forEach(btn => btn.classList.add('disabled'));
                
                this.inputArea.disabled = false;
                this.inputArea.value = '';
                this.inputArea.focus();
                
                this.trackLines.classList.remove('paused');
                
                document.getElementById('playerCar').style.transform = 'translateX(0)';
                document.getElementById('opponentCar').style.transform = 'translateX(0)';
                
                this.loadNewQuote();
                this.startTimer();
                this.startOpponent();
            },
            
            loadNewQuote() {
                const quotes = this.quotes[this.difficulty];
                this.currentQuote = quotes[Math.floor(Math.random() * quotes.length)];
                this.currentPosition = 0;
                this.displayQuote();
            },
            
            displayQuote() {
                this.quoteDisplay.innerHTML = this.currentQuote
                    .split('')
                    .map((char, index) => `<span id="char${index}">${char}</span>`)
                    .join('');
            },
            
            updateDisplay() {
                const typedText = this.inputArea.value;
                const currentWordStart = this.currentPosition;
                
                // Clear all highlights first from current position onwards
                for (let i = currentWordStart; i < this.currentQuote.length; i++) {
                    const charElement = document.getElementById(`char${i}`);
                    if (charElement) {
                        charElement.classList.remove('correct', 'incorrect', 'current');
                    }
                }
                
                // Highlight typed characters
                for (let i = 0; i < typedText.length; i++) {
                    const charElement = document.getElementById(`char${currentWordStart + i}`);
                    if (charElement) {
                        if (typedText[i] === this.currentQuote[currentWordStart + i]) {
                            charElement.classList.add('correct');
                        } else {
                            charElement.classList.add('incorrect');
                        }
                    }
                }
                
                // Highlight next character
                const nextCharElement = document.getElementById(`char${currentWordStart + typedText.length}`);
                if (nextCharElement) {
                    nextCharElement.classList.add('current');
                }
            },
            
            handleInput() {
                if (!this.isPlaying) return;
                
                const typedText = this.inputArea.value;
                const expectedText = this.currentQuote.substring(this.currentPosition, this.currentPosition + typedText.length);
                
                // Check if typing is correct
                let isCorrect = true;
                for (let i = 0; i < typedText.length; i++) {
                    if (typedText[i] !== expectedText[i]) {
                        isCorrect = false;
                        break;
                    }
                }
                
                if (!isCorrect && !this.shieldActive) {
                    // ERROR - Reset input and show error
                    this.inputArea.classList.add('error');
                    this.inputArea.value = '';
                    this.totalErrors++;
                    this.combo = 0;
                    this.correctStreak = 0;
                    this.updatePowerupStates();
                    
                    // Find current word boundaries to show error
                    let wordStart = this.currentPosition;
                    let wordEnd = this.currentQuote.indexOf(' ', this.currentPosition);
                    if (wordEnd === -1) wordEnd = this.currentQuote.length;
                    
                    // Flash error on current word
                    for (let i = wordStart; i < wordEnd; i++) {
                        const charElement = document.getElementById(`char${i}`);
                        if (charElement) {
                            charElement.classList.add('incorrect');
                            setTimeout(() => charElement.classList.remove('incorrect'), 500);
                        }
                    }
                    
                    setTimeout(() => {
                        this.inputArea.classList.remove('error');
                        this.updateDisplay();
                    }, 300);
                    
                    this.updateStats();
                    return;
                }
                
                // Update display for correct typing
                this.updateDisplay();
                
                // Check if space (word completed)
                if (typedText.endsWith(' ') && this.currentQuote[this.currentPosition + typedText.length - 1] === ' ') {
                    this.currentPosition += typedText.length;
                    this.totalTyped += typedText.length;
                    this.inputArea.value = '';
                    
                    // Increase combo
                    this.correctStreak++;
                    if (this.correctStreak >= 3) {
                        this.combo++;
                        if (this.combo > this.maxCombo) {
                            this.maxCombo = this.combo;
                        }
                        this.score += this.combo * 10;
                        this.updatePowerupStates();
                        
                        if (this.combo % 10 === 0) {
                            this.showCombo(this.combo);
                        }
                    }
                }
                
                this.updateStats();
                this.updateCarPosition();
                
                // FIX BUG: Check if quote completed (sudah sampai ujung)
                if (this.currentPosition >= this.currentQuote.length) {
                    this.score += 500;
                    this.loadNewQuote();
                    return;
                }
                
                // Additional check: if typed all remaining characters without space at the end
                if (this.currentPosition + typedText.length >= this.currentQuote.length && isCorrect) {
                    this.totalTyped += typedText.length;
                    this.score += 500;
                    this.loadNewQuote();
                    return;
                }
            },
            
            updatePowerupStates() {
                const powerups = [
                    { id: 'powerupBoost', cost: 10 },
                    { id: 'powerupSlow', cost: 15 },
                    { id: 'powerupShield', cost: 20 }
                ];
                
                powerups.forEach(({ id, cost }) => {
                    const element = document.getElementById(id);
                    if (this.combo >= cost) {
                        element.classList.remove('disabled');
                    } else {
                        element.classList.add('disabled');
                    }
                });
            },
            
            showCombo(combo) {
                const comboDisplay = document.getElementById('comboDisplay');
                comboDisplay.textContent = `${combo}X COMBO!`;
                comboDisplay.classList.add('show');
                setTimeout(() => comboDisplay.classList.remove('show'), 1000);
            },
            
            updateStats() {
                const timeElapsed = 60 - this.timeLeft;
                const minutes = timeElapsed / 60;
                const wpm = minutes > 0 ? Math.round((this.totalTyped / 5) / minutes) : 0;
                const accuracy = this.totalTyped > 0 
                    ? Math.round(((this.totalTyped - this.totalErrors) / this.totalTyped) * 100) 
                    : 100;
                
                document.getElementById('wpm').textContent = wpm;
                document.getElementById('combo').textContent = this.combo;
                document.getElementById('score').textContent = this.score;
                document.getElementById('accuracy').textContent = Math.max(0, accuracy);
            },
            
            updateCarPosition() {
                const progress = (this.currentPosition / this.currentQuote.length) * 70;
                document.getElementById('playerCar').style.transform = `translateX(${Math.min(progress, 70)}vw)`;
            },
            
            startTimer() {
                this.timerInterval = setInterval(() => {
                    this.timeLeft--;
                    document.getElementById('timer').textContent = this.timeLeft;
                    
                    if (this.timeLeft <= 0) {
                        this.endGame();
                    }
                }, 1000);
            },
            
            startOpponent() {
                this.opponentInterval = setInterval(() => {
                    const currentPos = parseFloat(document.getElementById('opponentCar').style.transform.replace(/[^\d.]/g, '') || 0);
                    const newPos = Math.min(currentPos + this.opponentSpeed, 70);
                    document.getElementById('opponentCar').style.transform = `translateX(${newPos}vw)`;
                }, 100);
            },
            
            usePowerup(type) {
                if (!this.isPlaying) return;
                
                const costs = { boost: 10, slow: 15, shield: 20 };
                if (this.combo < costs[type]) return;
                
                this.combo -= costs[type];
                
                if (type === 'boost') {
                    this.score += 200;
                    this.showCombo('‚ö° BOOST!');
                    const element = document.getElementById('powerupBoost');
                    element.classList.add('active');
                    setTimeout(() => element.classList.remove('active'), 1000);
                    
                } else if (type === 'slow') {
                    const originalSpeed = this.opponentSpeed;
                    this.opponentSpeed *= 0.3;
                    this.showCombo('üêå SLOWED!');
                    const element = document.getElementById('powerupSlow');
                    element.classList.add('active');
                    setTimeout(() => {
                        this.opponentSpeed = originalSpeed;
                        element.classList.remove('active');
                    }, 5000);
                    
                } else if (type === 'shield') {
                    this.shieldActive = true;
                    this.showCombo('üõ°Ô∏è SHIELD!');
                    const element = document.getElementById('powerupShield');
                    element.classList.add('active');
                    setTimeout(() => {
                        this.shieldActive = false;
                        element.classList.remove('active');
                    }, 5000);
                }
                
                this.updatePowerupStates();
                this.updateStats();
            },
            
            endGame() {
                clearInterval(this.timerInterval);
                clearInterval(this.opponentInterval);
                this.isPlaying = false;
                this.inputArea.disabled = true;
                this.trackLines.classList.add('paused');
                
                document.getElementById('startBtn').disabled = false;
                document.querySelectorAll('.diff-btn').forEach(btn => btn.classList.remove('disabled'));
                
                const wpm = parseInt(document.getElementById('wpm').textContent);
                const accuracy = document.getElementById('accuracy').textContent;
                
                document.getElementById('finalWPM').textContent = wpm;
                document.getElementById('finalCombo').textContent = this.maxCombo;
                document.getElementById('finalScore').textContent = this.score;
                document.getElementById('finalAccuracy').textContent = accuracy;
                
                this.showAchievements(wpm, parseInt(accuracy));
                
                document.getElementById('gameOverModal').classList.add('show');
            },
            
            showAchievements(wpm, accuracy) {
                const achievements = [];
                
                if (wpm >= 80) achievements.push('üöÄ HYPERSONIC');
                else if (wpm >= 60) achievements.push('‚ö° LIGHTNING FAST');
                else if (wpm >= 40) achievements.push('üî• SPEED DEMON');
                
                if (accuracy === 100) achievements.push('üíé FLAWLESS');
                else if (accuracy >= 95) achievements.push('üéØ SHARPSHOOTER');
                
                if (this.maxCombo >= 50) achievements.push('üî• COMBO MASTER');
                if (this.score >= 5000) achievements.push('üèÜ HIGH SCORER');
                if (this.difficulty === 'insane') achievements.push('üíÄ INSANE MODE');
                
                const achievementsDiv = document.getElementById('achievements');
                achievementsDiv.innerHTML = achievements
                    .map(badge => `<span class="badge">${badge}</span>`)
                    .join('');
            },
            
            closeModal() {
                document.getElementById('gameOverModal').classList.remove('show');
            },
            
            resetGame() {
                clearInterval(this.timerInterval);
                clearInterval(this.opponentInterval);
                this.isPlaying = false;
                this.timeLeft = 60;
                this.combo = 0;
                this.score = 0;
                this.totalTyped = 0;
                this.totalErrors = 0;
                this.currentPosition = 0;
                this.trackLines.classList.add('paused');
                
                document.getElementById('timer').textContent = 60;
                document.getElementById('wpm').textContent = 0;
                document.getElementById('combo').textContent = 0;
                document.getElementById('score').textContent = 0;
                document.getElementById('accuracy').textContent = 100;
                
                document.getElementById('startBtn').disabled = false;
                document.querySelectorAll('.diff-btn').forEach(btn => btn.classList.remove('disabled'));
                document.querySelectorAll('.powerup').forEach(p => {
                    p.classList.add('disabled');
                    p.classList.remove('active');
                });
                
                this.inputArea.value = '';
                this.inputArea.disabled = true;
                this.quoteDisplay.innerHTML = 'Press START to begin your race!';
                
                document.getElementById('playerCar').style.transform = 'translateX(0)';
                document.getElementById('opponentCar').style.transform = 'translateX(0)';
            }
        };
        
        game.init();
    </script>
</body>
</html>
